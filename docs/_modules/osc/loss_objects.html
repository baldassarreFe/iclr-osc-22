<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>osc.loss_objects &mdash; ICLR OSC 2022 0.0.1 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> ICLR OSC 2022
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../setup.html">Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_autosummary/osc.html">API Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">ICLR OSC 2022</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Module code</a> &raquo;</li>
      <li>osc.loss_objects</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for osc.loss_objects</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Tuple</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy.optimize</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">Tensor</span>
<span class="kn">from</span> <span class="nn">torch.nn.functional</span> <span class="kn">import</span> <span class="n">cross_entropy</span>

<span class="kn">from</span> <span class="nn">osc.utils</span> <span class="kn">import</span> <span class="n">cos_pairwise</span><span class="p">,</span> <span class="n">l2_normalize</span>


<div class="viewcode-block" id="matching_contrastive_loss"><a class="viewcode-back" href="../../_autosummary/osc.loss_objects.matching_contrastive_loss.html#osc.loss_objects.matching_contrastive_loss">[docs]</a><span class="k">def</span> <span class="nf">matching_contrastive_loss</span><span class="p">(</span>
    <span class="n">slots</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
    <span class="n">temperature</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="n">reduction</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;mean&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Contrastive object-wise loss, all vs. all.</span>

<span class="sd">    The vectors in position ``i`` and ``i + B`` of `projs` must represent ``K``</span>
<span class="sd">    embeddings of different augmentations of the same image. For each ``(i, i+B)``</span>
<span class="sd">    image pair, the ``K`` embeddings are 1:1 matched using linear-sum assignment</span>
<span class="sd">    to produce the targets for a ``2BK-1``-classes classification problem.</span>
<span class="sd">    Except for the matching slot, all ``2BK-2`` x of all images are considered</span>
<span class="sd">    negative samples for the loss.</span>

<span class="sd">    If all slot embeddings collapse to the same value, the loss will be ``log(2BK-1)``.</span>

<span class="sd">    Worst case:</span>
<span class="sd">    if all embeddings collapse to the same value, the loss will be ``log(2BK-1)``.</span>

<span class="sd">    Best case:</span>
<span class="sd">    if each image gets an embedding that is orthogonal to all others,</span>
<span class="sd">    the loss will be ``log(exp(1/t) + 2BK - 2) - 1/t``.</span>

<span class="sd">    Args:</span>
<span class="sd">        slots: [2B, K, C] tensor of projected image features</span>
<span class="sd">        temperature: temperature scaling</span>
<span class="sd">        reduction: &#39;mean&#39;, &#39;sum&#39;, or &#39;none&#39;</span>

<span class="sd">    Returns:</span>
<span class="sd">        Scalar loss over all samples and x if reduction is &#39;mean&#39; or &#39;sum&#39;.</span>
<span class="sd">        A vector ``2BK`` of losses if reduction is &#39;none&#39;</span>

<span class="sd">    Example:</span>
<span class="sd">        A batch of ``B=4`` images, augmented twice, each with `K=3` x.</span>
<span class="sd">        The ``X`` represent positive matching targets for the cross entropy loss,</span>
<span class="sd">        the ``.`` represent negatives included in the loss (all except diagonal)::</span>

<span class="sd">                                    aug_0                    aug_1</span>
<span class="sd">                           -----------------------  -----------------------</span>
<span class="sd">                             0     1     2     3      0     1     2     3</span>
<span class="sd">                  |       [  . .|. . .|. . .|. . .||. . X|. . .|. . .|. . .]</span>
<span class="sd">                  | img_0 [.   .|. . .|. . .|. . .||. X .|. . .|. . .|. . .]</span>
<span class="sd">                  |       [. .  |. . .|. . .|. . .||X . .|. . .|. . .|. . .]</span>
<span class="sd">                  |       [-----+-----+-----+------------+-----+-----+-----]</span>
<span class="sd">                  |       [. . .|  . .|. . .|. . .||. . .|X . .|. . .|. . .]</span>
<span class="sd">                  | img_1 [. . .|.   .|. . .|. . .||. . .|. X .|. . .|. . .]</span>
<span class="sd">                  |       [. . .|. .  |. . .|. . .||. . .|. . X|. . .|. . .]</span>
<span class="sd">            aug_0 |       [-----+-----+-----+------------+-----+-----+-----]</span>
<span class="sd">                  |       [. . .|. . .|  . .|. . .||. . .|. . .|. . X|. . .]</span>
<span class="sd">                  | img_2 [. . .|. . .|.   .|. . .||. . .|. . .|X . .|. . .]</span>
<span class="sd">                  |       [. . .|. . .|. .  |. . .||. . .|. . .|. X .|. . .]</span>
<span class="sd">                  |       [-----+-----+-----+------------+-----+-----+-----]</span>
<span class="sd">                  |       [. . .|. . .|. . .|  . .||. . .|. . .|. . .|. . X]</span>
<span class="sd">                  | img_3 [. . .|. . .|. . .|.   .||. . .|. . .|. . .|. X .]</span>
<span class="sd">                  |       [. . .|. . .|. . .|. .  ||. . .|. . .|. . .|X . .]</span>
<span class="sd">                          [=====|=====|=====|============|=====|=====|=====]</span>
<span class="sd">                  |       [. . X|. . .|. . .|. . .||  . .|. . .|. . .|. . .]</span>
<span class="sd">                  | img_0 [. X .|. . .|. . .|. . .||.   .|. . .|. . .|. . .]</span>
<span class="sd">                  |       [X . .|. . .|. . .|. . .||. .  |. . .|. . .|. . .]</span>
<span class="sd">                  |       [-----+-----+-----+------------+-----+-----+-----]</span>
<span class="sd">                  |       [. . .|X . .|. . .|. . .||. . .|  . .|. . .|. . .]</span>
<span class="sd">                  | img_1 [. . .|. X .|. . .|. . .||. . .|.   .|. . .|. . .]</span>
<span class="sd">                  |       [. . .|. . X|. . .|. . .||. . .|. .  |. . .|. . .]</span>
<span class="sd">            aug_1 |       [-----+-----+-----+------------+-----+-----+-----]</span>
<span class="sd">                  |       [. . .|. . .|. X .|. . .||. . .|. . .|  . .|. . .]</span>
<span class="sd">                  | img_2 [. . .|. . .|. . X|. . .||. . .|. . .|.   .|. . .]</span>
<span class="sd">                  |       [. . .|. . .|X . .|. . .||. . .|. . .|. .  |. . .]</span>
<span class="sd">                  |       [-----+-----+-----+------------+-----+-----+-----]</span>
<span class="sd">                  |       [. . .|. . .|. . .|. . X||. . .|. . .|. . .|  . .]</span>
<span class="sd">                  | img_3 [. . .|. . .|. . .|. X .||. . .|. . .|. . .|.   .]</span>
<span class="sd">                  |       [. . .|. . .|. . .|X . .||. . .|. . .|. . .|. .  ]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">A</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">slots</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="n">A</span>
    <span class="n">K</span> <span class="o">=</span> <span class="n">slots</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Full cosine similarity matrix between all slots of all images.</span>
    <span class="c1"># cos: [2, B, K, 2, B, K]</span>
    <span class="n">slots</span> <span class="o">=</span> <span class="n">slots</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">A</span> <span class="o">*</span> <span class="n">B</span> <span class="o">*</span> <span class="n">K</span><span class="p">,</span> <span class="n">slots</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">cos</span> <span class="o">=</span> <span class="n">cos_pairwise</span><span class="p">(</span><span class="n">slots</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">K</span><span class="p">)</span>

    <span class="c1"># Prepare cross-entropy targets by running linear sum assignment</span>
    <span class="c1"># on cosine similarity for each pair of augmented images.</span>
    <span class="c1">#</span>
    <span class="c1"># Thanks to symmetry w.r.t. the diagonal, matches need to be computed</span>
    <span class="c1"># only for the B blocks of size [K, K] in the diagonal of the top-right</span>
    <span class="c1"># quarter of the cosine matrix:</span>
    <span class="c1">#   for i in range(B):</span>
    <span class="c1">#       match(cos_pairwise(slots[i], slots[i+B]))</span>
    <span class="c1"># instead of 2B times:</span>
    <span class="c1">#   for i in range(2*B):</span>
    <span class="c1">#       match(cos_pairwise(slots[i % B], slots[(i+B) % B]))</span>

    <span class="n">targets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">A</span> <span class="o">*</span> <span class="n">B</span> <span class="o">*</span> <span class="n">K</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">B</span><span class="p">):</span>
        <span class="n">cos_np</span> <span class="o">=</span> <span class="n">cos</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="c1"># First output is a vector of sorted row idxs [0, 1, ..., K]</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">cols</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">linear_sum_assignment</span><span class="p">(</span><span class="n">cos_np</span><span class="p">,</span> <span class="n">maximize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">targets</span><span class="p">[</span><span class="n">b</span> <span class="o">*</span> <span class="n">K</span> <span class="p">:</span> <span class="p">(</span><span class="n">b</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">K</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">B</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span> <span class="o">*</span> <span class="n">K</span> <span class="o">+</span> <span class="n">cols</span>
        <span class="n">targets</span><span class="p">[(</span><span class="n">B</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span> <span class="o">*</span> <span class="n">K</span> <span class="p">:</span> <span class="p">(</span><span class="n">B</span> <span class="o">+</span> <span class="n">b</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">K</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span> <span class="o">*</span> <span class="n">K</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span>
    <span class="n">targets</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">slots</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

    <span class="n">cos</span> <span class="o">=</span> <span class="n">cos</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">A</span> <span class="o">*</span> <span class="n">B</span> <span class="o">*</span> <span class="n">K</span><span class="p">,</span> <span class="n">A</span> <span class="o">*</span> <span class="n">B</span> <span class="o">*</span> <span class="n">K</span><span class="p">)</span><span class="o">.</span><span class="n">div_</span><span class="p">(</span><span class="n">temperature</span><span class="p">)</span><span class="o">.</span><span class="n">fill_diagonal_</span><span class="p">(</span><span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">cross_entropy</span><span class="p">(</span><span class="n">cos</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="n">reduction</span><span class="p">)</span>

    <span class="c1"># Debug</span>
    <span class="c1"># with np.printoptions(linewidth=150, formatter={&quot;bool&quot;: &quot;.X&quot;.__getitem__}):</span>
    <span class="c1">#     probs = cos.detach().softmax(dim=-1).mul_(100).int().cpu().numpy()</span>
    <span class="c1">#     print(probs)</span>
    <span class="c1">#     onehot = np.zeros(cos.shape, dtype=bool)</span>
    <span class="c1">#     onehot[np.arange(len(targets)), targets.cpu().numpy()] = 1</span>
    <span class="c1">#     print(onehot)</span>

    <span class="k">return</span> <span class="n">loss</span></div>


<div class="viewcode-block" id="matching_contrastive_loss_best_worst"><a class="viewcode-back" href="../../_autosummary/osc.loss_objects.matching_contrastive_loss_best_worst.html#osc.loss_objects.matching_contrastive_loss_best_worst">[docs]</a><span class="k">def</span> <span class="nf">matching_contrastive_loss_best_worst</span><span class="p">(</span>
    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">num_slots</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">temperature</span><span class="p">:</span> <span class="nb">float</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Best and worst case for ``contrastive_loss()``.&quot;&quot;&quot;</span>
    <span class="n">best</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">temperature</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">batch_size</span> <span class="o">*</span> <span class="n">num_slots</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
        <span class="o">-</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">temperature</span>
    <span class="p">)</span>
    <span class="n">worst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">batch_size</span> <span class="o">*</span> <span class="n">num_slots</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">best</span><span class="p">,</span> <span class="n">worst</span></div>


<div class="viewcode-block" id="matching_contrastive_loss_per_img"><a class="viewcode-back" href="../../_autosummary/osc.loss_objects.matching_contrastive_loss_per_img.html#osc.loss_objects.matching_contrastive_loss_per_img">[docs]</a><span class="k">def</span> <span class="nf">matching_contrastive_loss_per_img</span><span class="p">(</span>
    <span class="n">slots</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">temperature</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">reduction</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;mean&quot;</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Contrastive object-wise loss, only between corresponding images.</span>

<span class="sd">    The ``K`` x of the ``i``-th image are matched with the x of the ``i+B``-th</span>
<span class="sd">    image and vice versa. For each slot, the contrastive image considers the matching</span>
<span class="sd">    slot in the corresponding image as positive. The other ``K-1`` x in the</span>
<span class="sd">    corresponding image as negatives, as well as the other ``K-1`` x in the original</span>
<span class="sd">    image. Slots are only matched between one image and its augmented version,</span>
<span class="sd">    never within the same image and never with other images.</span>

<span class="sd">    If all slot embeddings collapse to the same value, the loss will be ``log(2K-2)``.</span>

<span class="sd">    Args:</span>
<span class="sd">        slots: [2B, K, C] tensor of projected image features</span>
<span class="sd">        temperature: temperature scaling</span>
<span class="sd">        reduction: &#39;mean&#39;, &#39;sum&#39;, or &#39;none&#39;</span>

<span class="sd">    Returns:</span>
<span class="sd">        Scalar loss over all samples and x if reduction is &#39;mean&#39; or &#39;sum&#39;.</span>
<span class="sd">        A vector ``2BK`` of losses if reduction is &#39;none&#39;</span>

<span class="sd">    Example:</span>
<span class="sd">        A batch of ``B=4`` images, augmented twice, each with `K=3` x.</span>
<span class="sd">        The ``X`` represent positive matching targets for the cross entropy loss,</span>
<span class="sd">        the ``.`` represent negatives included in the loss (only from the augmented</span>
<span class="sd">        image and the image itself, but not the slot itself)::</span>

<span class="sd">                                    aug_0                    aug_1</span>
<span class="sd">                           -----------------------  -----------------------</span>
<span class="sd">                             0     1     2     3      0     1     2     3</span>
<span class="sd">                  |       [  . .|     |     |     ||. . X|     |     |     ]</span>
<span class="sd">                  | img_0 [.   .|     |     |     ||. X .|     |     |     ]</span>
<span class="sd">                  |       [. .  |     |     |     ||X . .|     |     |     ]</span>
<span class="sd">                  |       [-----+-----+-----+------------+-----+-----+-----]</span>
<span class="sd">                  |       [     |  . .|     |     ||     |X . .|     |     ]</span>
<span class="sd">                  | img_1 [     |.   .|     |     ||     |. X .|     |     ]</span>
<span class="sd">                  |       [     |. .  |     |     ||     |. . X|     |     ]</span>
<span class="sd">            aug_0 |       [-----+-----+-----+------------+-----+-----+-----]</span>
<span class="sd">                  |       [     |     |  . .|     ||     |     |. . X|     ]</span>
<span class="sd">                  | img_2 [     |     |.   .|     ||     |     |X . .|     ]</span>
<span class="sd">                  |       [     |     |. .  |     ||     |     |. X .|     ]</span>
<span class="sd">                  |       [-----+-----+-----+------------+-----+-----+-----]</span>
<span class="sd">                  |       [     |     |     |  . .||     |     |     |. . X]</span>
<span class="sd">                  | img_3 [     |     |     |.   .||     |     |     |. X .]</span>
<span class="sd">                  |       [     |     |     |. .  ||     |     |     |X . .]</span>
<span class="sd">                          [=====|=====|=====|============|=====|=====|=====]</span>
<span class="sd">                  |       [. . X|     |     |     ||  . .|     |     |     ]</span>
<span class="sd">                  | img_0 [. X .|     |     |     ||.   .|     |     |     ]</span>
<span class="sd">                  |       [X . .|     |     |     ||. .  |     |     |     ]</span>
<span class="sd">                  |       [-----+-----+-----+------------+-----+-----+-----]</span>
<span class="sd">                  |       [     |X . .|     |     ||     |  . .|     |     ]</span>
<span class="sd">                  | img_1 [     |. X .|     |     ||     |.   .|     |     ]</span>
<span class="sd">                  |       [     |. . X|     |     ||     |. .  |     |     ]</span>
<span class="sd">            aug_1 |       [-----+-----+-----+------------+-----+-----+-----]</span>
<span class="sd">                  |       [     |     |. X .|     ||     |     |  . .|     ]</span>
<span class="sd">                  | img_2 [     |     |. . X|     ||     |     |.   .|     ]</span>
<span class="sd">                  |       [     |     |X . .|     ||     |     |. .  |     ]</span>
<span class="sd">                  |       [-----+-----+-----+------------+-----+-----+-----]</span>
<span class="sd">                  |       [     |     |     |. . X||     |     |     |  . .]</span>
<span class="sd">                  | img_3 [     |     |     |. X .||     |     |     |.   .]</span>
<span class="sd">                  |       [     |     |     |X . .||     |     |     |. .  ]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># slots: [2B K C] -&gt; [2 B K C]</span>
    <span class="n">A</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">slots</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="n">A</span>
    <span class="n">K</span> <span class="o">=</span> <span class="n">slots</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">slots</span> <span class="o">=</span> <span class="n">l2_normalize</span><span class="p">(</span><span class="n">slots</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">slots</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

    <span class="c1"># cos_self0: [B K K] (each image with aug=0 with itself, ignore diagonal)</span>
    <span class="n">cos_self0</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;bkc,blc-&gt;bkl&quot;</span><span class="p">,</span> <span class="n">slots</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">slots</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">div_</span><span class="p">(</span><span class="n">temperature</span><span class="p">)</span>
    <span class="n">cos_self0</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">slots</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
        <span class="n">cos_self0</span><span class="o">.</span><span class="n">new_tensor</span><span class="p">(</span><span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">inf</span><span class="p">),</span>
        <span class="n">cos_self0</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># cos_self1: [B K K] (each image with aug=1 with itself, ignore diagonal)</span>
    <span class="n">cos_self1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;bkc,blc-&gt;bkl&quot;</span><span class="p">,</span> <span class="n">slots</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">slots</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">div_</span><span class="p">(</span><span class="n">temperature</span><span class="p">)</span>
    <span class="n">cos_self1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">slots</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
        <span class="n">cos_self1</span><span class="o">.</span><span class="n">new_tensor</span><span class="p">(</span><span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">inf</span><span class="p">),</span>
        <span class="n">cos_self1</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># cos_aug: [B K K] (each image with its augmented version)</span>
    <span class="n">cos_aug</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;bkc,blc-&gt;bkl&quot;</span><span class="p">,</span> <span class="n">slots</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">slots</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">div_</span><span class="p">(</span><span class="n">temperature</span><span class="p">)</span>

    <span class="c1"># Prepare targets</span>
    <span class="n">cos_np</span> <span class="o">=</span> <span class="n">cos_aug</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="n">targets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">A</span> <span class="o">*</span> <span class="n">B</span> <span class="o">*</span> <span class="n">K</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">B</span><span class="p">):</span>
        <span class="c1"># First output is a vector of sorted row indices [0, 1, ..., K]</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">cols</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">linear_sum_assignment</span><span class="p">(</span><span class="n">cos_np</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="n">maximize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">targets</span><span class="p">[</span><span class="n">b</span> <span class="o">*</span> <span class="n">K</span> <span class="p">:</span> <span class="p">(</span><span class="n">b</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">K</span><span class="p">]</span> <span class="o">=</span> <span class="n">K</span> <span class="o">+</span> <span class="n">cols</span>
        <span class="n">targets</span><span class="p">[</span><span class="n">B</span> <span class="o">*</span> <span class="n">K</span> <span class="o">+</span> <span class="n">b</span> <span class="o">*</span> <span class="n">K</span> <span class="p">:</span> <span class="n">B</span> <span class="o">*</span> <span class="n">K</span> <span class="o">+</span> <span class="p">(</span><span class="n">b</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">K</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span>
    <span class="n">targets</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">slots</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

    <span class="c1"># cos: [2BK, 2K]</span>
    <span class="n">cos</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">cos_self0</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">B</span> <span class="o">*</span> <span class="n">K</span><span class="p">,</span> <span class="n">K</span><span class="p">),</span>
                    <span class="n">cos_aug</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">B</span> <span class="o">*</span> <span class="n">K</span><span class="p">,</span> <span class="n">K</span><span class="p">),</span>
                <span class="p">],</span>
                <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">cos_aug</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">B</span> <span class="o">*</span> <span class="n">K</span><span class="p">,</span> <span class="n">K</span><span class="p">),</span>
                    <span class="n">cos_self1</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">B</span> <span class="o">*</span> <span class="n">K</span><span class="p">,</span> <span class="n">K</span><span class="p">),</span>
                <span class="p">],</span>
                <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">],</span>
        <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">cross_entropy</span><span class="p">(</span><span class="n">cos</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="n">reduction</span><span class="p">)</span>

    <span class="c1"># Debug</span>
    <span class="c1"># with np.printoptions(linewidth=150, formatter={&quot;bool&quot;: &quot;.X&quot;.__getitem__}):</span>
    <span class="c1">#     probs = cos.detach().softmax(dim=-1).mul_(100).int().cpu().numpy()</span>
    <span class="c1">#     print(probs)</span>
    <span class="c1">#     onehot = np.zeros(cos.shape, dtype=bool)</span>
    <span class="c1">#     onehot[np.arange(len(targets)), targets.cpu().numpy()] = 1</span>
    <span class="c1">#     print(onehot)</span>

    <span class="k">return</span> <span class="n">loss</span></div>


<div class="viewcode-block" id="matching_similarity_loss_per_img"><a class="viewcode-back" href="../../_autosummary/osc.loss_objects.matching_similarity_loss_per_img.html#osc.loss_objects.matching_similarity_loss_per_img">[docs]</a><span class="k">def</span> <span class="nf">matching_similarity_loss_per_img</span><span class="p">(</span>
    <span class="n">f</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">p</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">reduction</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;mean&quot;</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Cosine similarity per object, only between corresponding images.</span>

<span class="sd">    The ``S`` slots of the ``i``-th image are matched with the slots of the ``i+B``-th</span>
<span class="sd">    image and vice versa. The loss encourages high cosine similarity between pairs.</span>
<span class="sd">    Similarity is defined as ``(1-cos)/2``.</span>

<span class="sd">    Args:</span>
<span class="sd">        f: [2B, S, C] tensor of pre-projection image features</span>
<span class="sd">        p: [2B, S, C] tensor of post-projection image features</span>
<span class="sd">        reduction: &#39;mean&#39;, &#39;sum&#39;, or &#39;none&#39;</span>

<span class="sd">    Returns:</span>
<span class="sd">        Scalar loss over all samples and slots if reduction is &#39;mean&#39; or &#39;sum&#39;.</span>
<span class="sd">        A vector ``2BS`` of losses if reduction is &#39;none&#39;</span>

<span class="sd">    Example:</span>
<span class="sd">        A batch of ``B=4`` images, augmented twice, each with `S=3` slots.</span>
<span class="sd">        The ``X`` matching pairs whose cosine similarity will be increased.</span>
<span class="sd">        When computing the cosine, the vectors along the column axis are detached</span>
<span class="sd">        to prevent gradient propagation::</span>

<span class="sd">                                    aug_0                    aug_1</span>
<span class="sd">                           -----------------------  -----------------------</span>
<span class="sd">                             0     1     2     3      0     1     2     3</span>
<span class="sd">                  |       [     |     |     |     ||    X|     |     |     ]</span>
<span class="sd">                  | img_0 [     |     |     |     ||  X  |     |     |     ]</span>
<span class="sd">                  |       [     |     |     |     ||X    |     |     |     ]</span>
<span class="sd">                  |       [-----+-----+-----+------------+-----+-----+-----]</span>
<span class="sd">                  |       [     |     |     |     ||     |X    |     |     ]</span>
<span class="sd">                  | img_1 [     |     |     |     ||     |  X  |     |     ]</span>
<span class="sd">                  |       [     |     |     |     ||     |    X|     |     ]</span>
<span class="sd">            aug_0 |       [-----+-----+-----+------------+-----+-----+-----]</span>
<span class="sd">                  |       [     |     |     |     ||     |     |    X|     ]</span>
<span class="sd">                  | img_2 [     |     |     |     ||     |     |X    |     ]</span>
<span class="sd">                  |       [     |     |     |     ||     |     |  X  |     ]</span>
<span class="sd">                  |       [-----+-----+-----+------------+-----+-----+-----]</span>
<span class="sd">                  |       [     |     |     |     ||     |     |     |    X]</span>
<span class="sd">                  | img_3 [     |     |     |     ||     |     |     |  X  ]</span>
<span class="sd">                  |       [     |     |     |     ||     |     |     |X    ]</span>
<span class="sd">                          [=====|=====|=====|============|=====|=====|=====]</span>
<span class="sd">                  |       [    X|     |     |     ||     |     |     |     ]</span>
<span class="sd">                  | img_0 [  X  |     |     |     ||     |     |     |     ]</span>
<span class="sd">                  |       [X    |     |     |     ||     |     |     |     ]</span>
<span class="sd">                  |       [-----+-----+-----+------------+-----+-----+-----]</span>
<span class="sd">                  |       [     |X    |     |     ||     |     |     |     ]</span>
<span class="sd">                  | img_1 [     |  X  |     |     ||     |     |     |     ]</span>
<span class="sd">                  |       [     |    X|     |     ||     |     |     |     ]</span>
<span class="sd">            aug_1 |       [-----+-----+-----+------------+-----+-----+-----]</span>
<span class="sd">                  |       [     |     |  X  |     ||     |     |     |     ]</span>
<span class="sd">                  | img_2 [     |     |    X|     ||     |     |     |     ]</span>
<span class="sd">                  |       [     |     |X    |     ||     |     |     |     ]</span>
<span class="sd">                  |       [-----+-----+-----+------------+-----+-----+-----]</span>
<span class="sd">                  |       [     |     |     |    X||     |     |     |     ]</span>
<span class="sd">                  | img_3 [     |     |     |  X  ||     |     |     |     ]</span>
<span class="sd">                  |       [     |     |     |X    ||     |     |     |     ]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># f: [2B S C] -&gt; [2 B S C]</span>
    <span class="n">A</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">B</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">D</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">B</span> <span class="o">//=</span> <span class="n">A</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">l2_normalize</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">l2_normalize</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>

    <span class="c1"># Cosine similarity of all slots in one image with all slots in its aug version,</span>
    <span class="c1"># will be used to compute the matching pairs. However, the loss is defined between</span>
    <span class="c1"># the detached pre-projection features and the post-projection features.</span>
    <span class="c1"># cos: [B S T], T=S</span>
    <span class="c1"># cos[b, s, t] = cos(f[0, b, s], f[1, b, t])</span>
    <span class="n">cos</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;bsc,btc-&gt;bst&quot;</span><span class="p">,</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

    <span class="c1"># Find matches and accumulate cosine similarity of matching pairs</span>
    <span class="n">sim</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">S</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">B</span><span class="p">):</span>
        <span class="c1"># First output is a vector of sorted row indices [0, 1, ..., S]</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">cols</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">linear_sum_assignment</span><span class="p">(</span><span class="n">cos</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="n">maximize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Top-right quadrant in the example matrix above</span>
        <span class="n">sim</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">cols</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Bottom-left quadrant in the example matrix above (symmetric)</span>
        <span class="n">cols_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span>
        <span class="n">sim</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">cols_t</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">reduction</span> <span class="o">==</span> <span class="s2">&quot;sum&quot;</span><span class="p">:</span>
        <span class="n">sim</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">reduction</span> <span class="o">==</span> <span class="s2">&quot;mean&quot;</span><span class="p">:</span>
        <span class="n">sim</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

    <span class="k">return</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">sim</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Federico Baldassarre.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>